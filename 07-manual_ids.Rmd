---
title: "07-manual_ids"
output: html_document
date: "2024-08-14"
---


```{r}
library(glmnet)
library(ranger)
library(caret)
library(MLmetrics)
```

```{r}
aggregated_dt <-
  fread('aggregated_dt_filtered.csv.gz', stringsAsFactors = TRUE)
load('aggregating.rda')
event_dirs <- c('event_models', 
                'event_models_smaller', 
                'event_models_local')
event_file_dt <- rbindlist(sapply(event_dirs, function(event_dir) {
  rbindlist(sapply(as.character(c(manual_ids, c(4021, 4022, 459, 979, 309))), function(id) {
      list(filename=list.files(event_dir, pattern = paste0('^', id, "[_.]"), full.names = TRUE))
  }, simplify = FALSE), idcol = 'ID')
}, simplify = FALSE), idcol = 'folder')
event_file_dt[grepl("robust", filename, fixed = TRUE)]
```


# CD45 / PTPRC

```{r}
# for each id in 4019:4022 for each event folder, list the .rds files starting with that id with lapply
event_model <- readRDS(event_file_dt[grepl("robust", filename, fixed = TRUE)][ID == 1658, filename])
summary(event_model$cvfit$`FALSE::OLS_GE`)
```


```{r}
event_dt[ID == 1658, !sample_cols, with = FALSE]
activeChromHMM[c(54093, 54111)]
event_gr[1658]
```
![CD45](CD451658.png)

# FN1

```{r}
event_model <- readRDS(event_file_dt[grepl("robust", filename, fixed = TRUE)][ID == 4022, filename])
summary(event_model$cvfit$`FALSE::OLS_GE`)
```

```{r}
event_dt[ID == 4022, !sample_cols, with = FALSE]
activeChromHMM[c(419854, 420041)]
event_gr[4022]
```

![FN1](FN4022.png)

# CTNND1

```{r}
event_model <- readRDS(event_file_dt[grepl("robust", filename, fixed = TRUE)][ID == 13897, filename])
summary(event_model$cvfit$`FALSE::OLS_GE`)
print(event_model$nsamples)
```

```{r}
event_dt[ID == 13897, !sample_cols, with = FALSE]
# activeChromHMM[c(419854, 420041)]
event_gr[13897]
```

<!-- ![CTNND1]() -->


# FGFR2

```{r}
# load the .rds file 
event_dt[ID %in% c(1048, 1049), !sample_cols, with = FALSE]
event_gr[c(1048, 1049)]
```

# first exon first:
```{r}
mxe1 <- readRDS("20240814_event_models/1049.rds")
mxe2 <- readRDS("20240814_event_models/1048.rds")
# read both feature tables
mxe1_dt <- fread(file.path("event_feature_tables", paste0("feature_table_", 1049, ".csv.gz")))
# correlate all columns in mxe1_dt with PSI
corrplot::corrplot(cor(as.matrix(mxe1_dt[, .(PSI, gene_expression, max_promoter, summed_enhancer, `DNAm;upstream_other_region`, `DNAm;event_name`, `DNAm;downstream_other_region`, `H3K36me3;upstream_other_region`, `H3K36me3;event_name`, `H3K36me3;downstream_other_region`, `H3K4me1;upstream_other_region`, `H3K4me1;event_name`, `H3K4me1;downstream_other_region`)]), method = 'spearman', use = "pairwise.complete.obs"))

mxe2_dt <- fread(file.path("event_feature_tables", paste0("feature_table_", 1048, ".csv.gz")))
corrplot::corrplot(cor(as.matrix(mxe2_dt[, .(PSI, gene_expression, max_promoter, summed_enhancer, `DNAm;upstream_other_region`, `DNAm;event_name`, `DNAm;downstream_other_region`, `H3K36me3;upstream_other_region`, `H3K36me3;event_name`, `H3K36me3;downstream_other_region`, `H3K4me1;upstream_other_region`, `H3K4me1;event_name`, `H3K4me1;downstream_other_region`)]), method = 'spearman', use = "pairwise.complete.obs"))
```

```{r}
ten_dt <- fread("event_feature_tables/feature_table_1048.csv.gz")
# for all columns in ten_dt, fill NAs with the column mean
ten_dt[, (names(ten_dt)) := lapply(.SD, function(x) ifelse(is.na(x), mean(x, na.rm = TRUE), x))]
# for all columns in ten_dt, scale the columns, if they are numeric, except for th
ten_dt[, (names(ten_dt)) := lapply(.SD, function(x) if (is.numeric(x) && !identical(x, ten_dt$PSI)) scale(x) else x)]


# ten_plot_dt[, .(r=cor(pred, trues), r2=MLmetrics::R2_Score(pred, trues), mse=MLmetrics::MSE(pred, trues), rmse=MLmetrics::RMSE(pred, trues), mae=MLmetrics::MAE(pred, trues))]
ten_dt[, harmonized_sample_ontology_term_high_order_fig1:=as.factor(harmonized_sample_ontology_term_high_order_fig1)]

lm_ten <- lm(PSI ~ ., data = as.data.frame(cbind(ten_dt[, 'PSI'], makeX(ten_dt[, "harmonized_sample_ontology_term_high_order_fig1"]))))
lm_ten_dt <- data.table(pred=predict(lm_ten), trues=ten_dt[, PSI], sample_ontology=ten_dt$harmonized_sample_ontology_term_high_order_fig1)
# lm_ten_dt[, .(r=cor(pred, trues), r2=MLmetrics::R2_Score(pred, trues), mse=MLmetrics::MSE(pred, trues), rmse=MLmetrics::RMSE(pred, trues), mae=MLmetrics::MAE(pred, trues))]
ggplot(lm_ten_dt, aes(x = trues, y = pred, color = sample_ontology)) + geom_point() + geom_smooth(method = "lm", se = FALSE) + theme_bw() + guides(color=guide_legend(ncol=2)) + ggtitle(lm_ten_dt[, paste0('Mean cell type r=', round(cor(pred, trues), 2), ', r2=', round(MLmetrics::R2_Score(pred, trues), 2), ', mse=', round(MLmetrics::MSE(pred, trues), 2), ', rmse=', round(MLmetrics::RMSE(pred, trues), 2), ', mae=', round(MLmetrics::MAE(pred, trues), 2))]) + geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "grey")


# ten_dt[, `H3K36me3;event_name`:=scale(`H3K36me3;event_name`)]

lme_ten <- glm(PSI ~ gene_expression + max_promoter + summed_enhancer + `DNAm;upstream_other_region` + `DNAm;event_name` + `DNAm;downstream_other_region` + `H3K36me3;upstream_other_region` + `H3K36me3;event_name` + `H3K36me3;downstream_other_region` + `H3K4me1;upstream_other_region` + `H3K4me1;event_name` + `H3K4me1;downstream_other_region`, data = ten_dt, family = "quasibinomial")
lme_ten_dt <- data.table(pred=predict(lme_ten, type = "response"), trues=ten_dt[, PSI], sample_ontology=ten_dt$harmonized_sample_ontology_term_high_order_fig1)
# lme_ten_dt[, .(r=cor(pred, trues), r2=MLmetrics::R2_Score(pred, trues), mse=MLmetrics::MSE(pred, trues), rmse=MLmetrics::RMSE(pred, trues), mae=MLmetrics::MAE(pred, trues))]
ggplot(lme_ten_dt, aes(x = trues, y = pred, color = sample_ontology)) + geom_point() + geom_smooth(method = "lm", se = FALSE) + theme_bw() + guides(color=guide_legend(ncol=2)) + ggtitle(lme_ten_dt[, paste0('many ones r=', round(cor(pred, trues), 2), ', r2=', round(MLmetrics::R2_Score(pred, trues), 2), ', mse=', round(MLmetrics::MSE(pred, trues), 2), ', rmse=', round(MLmetrics::RMSE(pred, trues), 2), ', mae=', round(MLmetrics::MAE(pred, trues), 2))]) + geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "grey")


# ten_dt[, `H3K36me3;event_name`:=scale(`H3K36me3;event_name`)]
lme_ten <- lme4::lmer(PSI ~ gene_expression + (1|harmonized_sample_ontology_term_high_order_fig1), data = ten_dt)
lme_ten_dt <- data.table(pred=predict(lme_ten), trues=ten_dt[, PSI], sample_ontology=ten_dt$harmonized_sample_ontology_term_high_order_fig1)
# lme_ten_dt[, .(r=cor(pred, trues), r2=MLmetrics::R2_Score(pred, trues), mse=MLmetrics::MSE(pred, trues), rmse=MLmetrics::RMSE(pred, trues), mae=MLmetrics::MAE(pred, trues))]
ggplot(lme_ten_dt, aes(x = trues, y = pred, color = sample_ontology)) + geom_point() + geom_smooth(method = "lm", se = FALSE) + theme_bw() + guides(color=guide_legend(ncol=2)) + ggtitle(lme_ten_dt[, paste0('gene_expression + cell_type r=', round(cor(pred, trues), 2), ', r2=', round(MLmetrics::R2_Score(pred, trues), 2), ', mse=', round(MLmetrics::MSE(pred, trues), 2), ', rmse=', round(MLmetrics::RMSE(pred, trues), 2), ', mae=', round(MLmetrics::MAE(pred, trues), 2))]) + geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "grey")


# ten_dt[, `H3K36me3;event_name`:=scale(`H3K36me3;event_name`)]
lme_ten <- lme4::lmer(PSI ~ gene_expression + (gene_expression|harmonized_sample_ontology_term_high_order_fig1), data = ten_dt)
lme_ten_dt <- data.table(pred=predict(lme_ten), trues=ten_dt[, PSI], sample_ontology=ten_dt$harmonized_sample_ontology_term_high_order_fig1)
# lme_ten_dt[, .(r=cor(pred, trues), r2=MLmetrics::R2_Score(pred, trues), mse=MLmetrics::MSE(pred, trues), rmse=MLmetrics::RMSE(pred, trues), mae=MLmetrics::MAE(pred, trues))]
ggplot(lme_ten_dt, aes(x = trues, y = pred, color = sample_ontology)) + geom_point() + geom_smooth(method = "lm", se = FALSE) + theme_bw() + guides(color=guide_legend(ncol=2)) + ggtitle(lme_ten_dt[, paste0('gene_expression|cell_type r=', round(cor(pred, trues), 2), ', r2=', round(MLmetrics::R2_Score(pred, trues), 2), ', mse=', round(MLmetrics::MSE(pred, trues), 2), ', rmse=', round(MLmetrics::RMSE(pred, trues), 2), ', mae=', round(MLmetrics::MAE(pred, trues), 2))]) + geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "grey")
```

